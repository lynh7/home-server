global:
  storageClass: longhorn
  security:
    allowInsecureImages: true
mysql:
  auth:
    rootPassword: "root"
    database: wordpress
    username: andy
    password: andy

  primary:
    persistence:
      enabled: true
      storageClass: longhorn
      size: 20Gi

redis:
  architecture: standalone
  auth:
    enabled: true
    password: "redispassword"
  master:
    persistence:
      enabled: true
  replica:
    persistence:
      enabled: true

minio:
  mode: standalone
  persistence:
    enabled: true
    storageClass: longhorn
    size: 20Gi

  rootUser: "minioadmin"
  rootPassword: "minioadminpassword"

  buckets:
    - name: wp-media
      policy: none
      purge: false

  service:
    type: ClusterIP
    port: 9000

wordpress:
  replicaCount: 2

  wordpressUsername: admin
  wordpressPassword: admin123
  wordpressEmail: admin@example.com
  wordpressBlogName: "My Blog"

  # Connect to MySQL
  externalDatabase:
    host: wordpress-stack-mysql
    user: andy
    password: andy
    database: wordpress
    port: 3306
  
  mariadb:
    enabled: false  # Disable built-in MariaDB

  # Disable persistence to make it stateless
  persistence:
    enabled: true
    storageClass: longhorn
    size: 5Gi
    # Only persist wp-content (plugins, themes, uploads if not using S3)
    existingClaim: ""

  # Enable Redis for caching/sessions
  redis:
    enabled: true
    host: wordpress-stack-redis-master
    port: 6379
    password: "redispassword"

  memcached:
    enabled: false
  
  # Install required plugins
  extraVolumes:
    - name: plugin-installer
      emptyDir: {}
  
  extraVolumeMounts:
    - name: plugin-installer
      mountPath: /tmp/plugins
  
    # Use lifecycle hook to install plugins after container starts
  lifecycleHooks:
    postStart:
      exec:
        command:
          - /bin/bash
          - -c
          - |
            # Wait for WordPress to be ready
            sleep 30
            # Install Redis plugin
            wp plugin install redis-cache --activate --allow-root || true
            # Install S3 plugin
            wp plugin install amazon-s3-and-cloudfront --activate --allow-root || true
            # Enable Redis
            wp redis enable --allow-root || true

  # Environment vars for S3 integration (MinIO)
  extraEnvVars:
    - name: WORDPRESS_CONFIG_EXTRA
      value: |
        define( 'WP_REDIS_HOST', 'wordpress-stack-redis-master' );
        define( 'WP_REDIS_PORT', '6379' );
        define( 'WP_REDIS_PASSWORD', 'redispassword' );  # Add this
        define( 'WP_REDIS_DATABASE', '0' );

        define( 'AS3CF_SETTINGS', serialize( array(
          'provider' => 'aws',
          'access-key-id' => 'minioadmin',
          'secret-access-key' => 'minioadminpassword',
          'bucket' => 'wp-media',
          'region' => 'us-east-1',
          'copy-to-s3' => true,
          'serve-from-s3' => true,
          'force-https' => false,
          'use-server-roles' => false,
          'endpoint' => 'http://wordpress-stack-minio.wordpress-dev01.svc.cluster.local:9000',
          'use-path-style-endpoints' => true,
        ) ) );
  
  # initContainers:
  #   - name: install-plugins
  #     image: wordpress:cli
  #     command:
  #       - /bin/sh
  #       - -c
  #       - |
  #         wp plugin install redis-cache --activate --allow-root
  #         wp plugin install amazon-s3-and-cloudfront --activate --allow-root
  #     volumeMounts:
  #       - name: wordpress-data
  #         mountPath: /var/www/html

  service:
    type: ClusterIP

  ingress:
    enabled: true
    hostname: wp.tks-dev01.lab
    ingressClassName: nginx